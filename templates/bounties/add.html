{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
<form id="bounty-for">
  <label
        id="bounty-status-label"
        for="bounty-status"
        style="display:none">
      Status
  </label>
  <select
      class="form-control"
      id="bounty-status"
      style="display:none">
    <option value="1">Open</option>
    <option value="2">Closed</option>
    <option value="3">Cancelled</option>
  </select>
  <br>

  <!-- Player Character -->
  <label
        id="player-characters-label"
        for="player-characters"
        style="display:none">
      Your character
  </label>
  <select
  		class="form-control"
      id="player-characters"
      style="display:none">
    <option value="">---</option>
  </select>
  <br>
  <!-- End block -->

  <!-- Realm -->
  <label
        id="realms-label"
        for="realms"
        style="display:none">
      Target realm
  </label>
  <select
  		class="form-control"
      id="realms"
      style="display:none">
    <option value="">---</option>
  </select>
  <br>
  <!-- End block -->
  
  <!-- Destination character -->
  <label
        id="destination-character-label"
        for="realms"
        style="display:none">
      Target name 
  </label>
  <input
      id="destination-character"
      style="display:none"
      class="form-control"
      type="text" />
  <br>
  <label
	    for="reward"
	    id="reward-label"
	    style="display:none">
	  Reward
	</label>
  <small class="help" style="display:none">
    <p class="help-block">Markdown allowed</p>
  </small>
	<textarea
			class="form-control"
	    id="reward"
	    style="display:none"
	    rows="4"
	    cols="50"></textarea>
  <br>
	<label
	    for="description"
	    id="description-label"
	    style="display:none">
	  Description
	</label>
  <small class="help" style="display:none">
    <p class="help-block">Markdown allowed</p>
  </small>
	<textarea
			class="form-control"
	    id="description"
	    style="display:none"
	    rows="4"
	    cols="50"></textarea>
	<br>
	<button
			class="btn btn-success"
	    id="save"
	    style="display:none">
	  Save
	</button>
</form>	
<!-- End block -->


{% endblock %}

{% block javascripts %}
<script>
  var selectedStatus = null;
  var selectedRegion = null;
  var selectedSourceRealm = null;
  var selectedSourceCharacter = null;
  var selectedDestinationRealm = null;
  var selectedDestinationCharacter = null;
  var reward = '';
  var description = '';

  function loadBounty(id) {
    $.ajax({
      url: "/api/bounty/" + id,
      dataType: 'json',
      success: function(data) {
        getRealms(data.region, function() {
          selectedRegion = data.region;
          selectedSourceRealm = data.source_realm;
          selectedSourceCharacter = data.source_character;
          selectedDestinationRealm = data.destination_realm;
          selectedDestinationCharacter = data.destination_character;
          reward = data.reward;
          description = data.description;
          selectedStatus = data.status;

          // Set character
          $("select#player-characters option").filter(function() {
              return $(this).val() == data.region + '|' + data.source_realm + '|' + data.source_character; 
          }).prop('selected', true);
          $("select#player-characters").attr('disabled', '');
          $("select#realms option").filter(function() {
              return $(this).val() == data.source_realm; 
          }).prop('selected', true);
          $("select#realms").attr('disabled', '');
          $("input#destination-character").val(selectedDestinationCharacter);
          $("input#destination-character").attr('disabled', '');
          $("textarea#reward").text(reward);
          $("textarea#description").text(description);
$("select#player-characters option").filter(function() {
              return $(this).val() == data.region + '|' + data.source_realm + '|' + data.source_character; 
          }).prop('selected', true);
          $("select#bounty-status option").filter(function() {
              return $(this).val() == data.status; 
          }).prop('selected', true);
          $("label#bounty-status-label").css('display', '');
          $("select#bounty-status").css('display', '');
        });
      },
      error: function(xhr, status, err) {
        console.error("/api/bounty/" + id, status, err.toString());
      }
    });
  };

  function getPlayerCharacters(callback) {
    $.ajax({
      url: "/api/player-characters",
      dataType: 'json',
      success: function(data) {
        $.map(data, function(val) {
          $("select#player-characters").append(
            "<option value=\"" + val.region + "|" + val.normalized_realm +
            "|"  + val.name + "\">" + val.name + " - " + val.realm +
            " (" + val.level + ") </option>");
        });
        $("select#player-characters").css("display", "block");
        $("label#player-characters-label").css("display", "block");
        if (callback)
          callback();
      },
      error: function(xhr, status, err) {
        console.error("/api/player-characters", status, err.toString());
      }
    });  
  };

  function getRealms(region, callback) {
    $.ajax({
      url: "/api/realms?region=" + region,
      dataType: 'json',
      success: function(data) {
        $("select#realms").text('');
        $.map(data, function(val) {
          $("select#realms").append(
            "<option value=\"" + val.slug + "\">" + val.name + "</option>");
        });
        $("select#realms").css("display", "block");
        $("label#realms-label").css("display", "block");
        $("input#destination-character").css("display", "block");
        $("label#destination-character-label").css("display", "block");
        $("textarea#reward").css("display", "block");
        $("label#reward-label").css("display", "block");
        $("textarea#description").css("display", "block");
        $("label#description-label").css("display", "block");
        $("button#save").css("display", "block");
        $(".help").css("display", "block");
        if (callback)
          callback();
      },
      error: function(xhr, status, err) {
        console.error("/api/realms?region=" + region, status, err.toString());
      }
    }); 
  };

  function checkFields() {
    selectedDestinationCharacter = $("input#destination-character").val();
    reward = $("textarea#reward").val();
    description = $("textarea#description").val();
    selectedStatus = $("select#bounty-status").val();

    var errorMessage = '';
    if (!selectedRegion)
      errorMessage += '\n- Missing region';
    if (!selectedSourceRealm || !selectedSourceCharacter)
      errorMessage += '\n- Your character is missing';
    if (!selectedDestinationRealm)
      errorMessage += '\n- Missing target realm';
    if (!selectedDestinationCharacter )
      errorMessage += '\n- Missing target name';
    if (!reward)
      errorMessage += '\n- Missing reward';
    if (!description)
      errorMessage += '\n- Missing description';

    if (errorMessage) {
      alert("Form is incomplet:\n" + errorMessage);
      return;
    }
  }

  function updateBounty() {
    checkFields();

    var bounty = {
      region: selectedRegion,
      source_realm: selectedSourceRealm,
      source_character: selectedSourceCharacter,
      destination_realm: selectedDestinationRealm,
      destination_character: selectedDestinationCharacter,
      description: description,
      reward: reward,
      status: selectedStatus,
    }
    $.ajax({
      url: "/api/bounty/" + getUrlParameter('update'),
      dataType: 'json',
      type: 'POST',
      data: bounty,
      success: function(data) {
        window.location = "/bounty/" + data.id;
      },
      error: function(xhr, status, err) {
        var jsonResponse = $.parseJSON(xhr.responseText)
        var errorMessage = '';
        if (jsonResponse.reasons) {
          $.map(jsonResponse.reasons, function(val) {
            errorMessage += '\n- ' + val;
          })
        }
        if (!errorMessage)
          errorMessage = '\n- Unknown error';

        alert("Bounty is incorrect:\n" + errorMessage);
        console.error("/api/bounty/" + getUrlParameter('update'), status, err.toString());
      }
    }); 
  }

  function saveBounty() {
    checkFields();

    var bounty = {
      region: selectedRegion,
      source_realm: selectedSourceRealm,
      source_character: selectedSourceCharacter,
      destination_realm: selectedDestinationRealm,
      destination_character: selectedDestinationCharacter,
      description: description,
      reward: reward,
    }
    $.ajax({
      url: "/api/bounty",
      dataType: 'json',
      type: 'POST',
      data: bounty,
      success: function(data) {
        window.location = "/bounty/" + data.id;
      },
      error: function(xhr, status, err) {
        var jsonResponse = $.parseJSON(xhr.responseText)
        var errorMessage = '';
        if (jsonResponse.reasons) {
          $.map(jsonResponse.reasons, function(val) {
            errorMessage += '\n- ' + val;
          })
        }
        if (!errorMessage)
          errorMessage = '\n- Unknown error';

        alert("Bounty is incorrect:\n" + errorMessage);
        console.error("/api/bounty", status, err.toString());
      }
    }); 
  };

$(function() {
  // When select character
  $("select#player-characters").change(function() {
    var character = $("select#player-characters").val()
    selectedRegion = character.split('|')[0];
    selectedSourceRealm = character.split('|')[1];
    selectedSourceCharacter = character.split('|')[2];
    console.log("selectedRegion:", selectedRegion);
    console.log("selectedSourceCharacter:", selectedSourceCharacter);
    console.log("selectedSourceRealm:", selectedSourceRealm);
    getRealms(selectedRegion);
  });
  // When select realm
  $("select#realms").change(function() {
    selectedDestinationRealm = $("select#realms").val();
    console.log("selectedDestinationRealm:", selectedDestinationRealm);
  });

  getPlayerCharacters(function() {
    if (getUrlParameter('update')) {
      loadBounty(getUrlParameter('update'));
      $("form#bounty-form").submit(function(e) {
        e.preventDefault();
        updateBounty();
      });
      $("button#save").click(function(e) {
        e.preventDefault();
        updateBounty();
      });
    } else {
      $("form#bounty-form").submit(function(e) {
        e.preventDefault();
        saveBounty();
      });
      $("button#save").click(function(e) {
        e.preventDefault();
        saveBounty();
      });
    }
  });
});
</script>
{% endblock %}
